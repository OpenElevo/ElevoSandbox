# 端到端测试场景

本文档定义了 Elevo Workspace 的端到端测试场景，覆盖 Sandbox、Process、NFS 文件系统等核心功能。

## 测试环境准备

```bash
# 启动服务
WORKSPACE_NFS_PORT=12049 cargo run --bin workspace-server

# 创建 NFS 挂载点
sudo mkdir -p /mnt/workspace_nfs
```

---

## 场景分类

### 1. Sandbox 生命周期测试

#### 1.1 创建 Sandbox
- **描述**: 创建一个新的 sandbox，验证返回正确的 sandbox 信息
- **预期**: 返回 sandbox ID，状态为 running，agent 已连接

#### 1.2 获取 Sandbox 信息
- **描述**: 通过 ID 获取 sandbox 详情
- **预期**: 返回完整的 sandbox 信息，包括状态、创建时间等

#### 1.3 列出所有 Sandbox
- **描述**: 列出当前所有 sandbox
- **预期**: 返回 sandbox 列表，包含之前创建的 sandbox

#### 1.4 删除 Sandbox
- **描述**: 删除一个 sandbox
- **预期**: sandbox 被删除，容器停止，workspace 目录清理

---

### 2. Process 执行测试

#### 2.1 执行简单命令
- **描述**: 在 sandbox 中执行 `echo "Hello World"`
- **预期**: exit_code=0, stdout="Hello World\n"

#### 2.2 执行带参数的命令
- **描述**: 执行 `ls -la /workspace`
- **预期**: 返回目录列表，exit_code=0

#### 2.3 执行失败的命令
- **描述**: 执行不存在的命令 `nonexistent_command`
- **预期**: exit_code!=0, stderr 包含错误信息

#### 2.4 执行带环境变量的命令
- **描述**: 设置环境变量并执行命令读取
- **预期**: 命令能读取到设置的环境变量

#### 2.5 执行长时间运行的命令
- **描述**: 执行 `sleep 2 && echo done`
- **预期**: 等待命令完成，返回正确结果

#### 2.6 执行命令写入文件
- **描述**: 执行 `echo "content" > /workspace/test.txt`
- **预期**: 文件被创建，内容正确

#### 2.7 执行命令读取文件
- **描述**: 先写入文件，再用 cat 读取
- **预期**: 返回正确的文件内容

---

### 3. NFS 文件系统测试

#### 3.1 NFS 挂载
- **描述**: 挂载 NFS 导出的 workspace 目录
- **预期**: 成功挂载，能看到 sandbox 目录

#### 3.2 通过 NFS 读取容器创建的文件
- **描述**: 容器内创建文件，通过 NFS 读取
- **预期**: NFS 挂载点能看到并读取文件内容

#### 3.3 通过 NFS 写入文件，容器内读取
- **描述**: 通过 NFS 写入文件，在容器内执行 cat 读取
- **预期**: 容器内能读取到 NFS 写入的内容

#### 3.4 通过 NFS 创建目录
- **描述**: 在 NFS 挂载点创建目录
- **预期**: 目录创建成功，容器内可见

#### 3.5 通过 NFS 删除文件
- **描述**: 通过 NFS 删除容器创建的文件
- **预期**: 文件被删除，容器内不可见

#### 3.6 大文件读写
- **描述**: 写入并读取一个较大的文件 (1MB)
- **预期**: 数据完整，无损坏

#### 3.7 并发文件操作
- **描述**: 同时从 NFS 和容器操作同一文件
- **预期**: 操作正确同步，数据一致

---

### 4. 综合场景测试

#### 4.1 完整工作流: 代码编辑和执行
- **描述**:
  1. 通过 NFS 写入 Python 脚本
  2. 在容器内执行脚本
  3. 验证输出结果
- **预期**: 脚本执行成功，输出正确

#### 4.2 完整工作流: 项目初始化
- **描述**:
  1. 在容器内执行 `mkdir -p /workspace/project`
  2. 通过 NFS 写入配置文件
  3. 在容器内读取并验证
- **预期**: 项目结构正确，配置文件可读

#### 4.3 多 Sandbox 隔离测试
- **描述**:
  1. 创建两个 sandbox
  2. 在 sandbox A 创建文件
  3. 验证 sandbox B 看不到该文件
- **预期**: sandbox 之间完全隔离

#### 4.4 Sandbox 重启后文件持久化
- **描述**:
  1. 创建 sandbox 并写入文件
  2. 删除 sandbox (保留数据)
  3. 创建新 sandbox 使用相同 workspace
  4. 验证文件仍存在
- **预期**: 文件在 workspace 中持久化

#### 4.5 NFS 导出在 Sandbox 删除后清理
- **描述**:
  1. 创建 sandbox
  2. 挂载 NFS 验证可见
  3. 删除 sandbox
  4. 验证 NFS 中不再可见
- **预期**: sandbox 删除后 NFS 导出自动清理

---

### 5. 错误处理测试

#### 5.1 操作不存在的 Sandbox
- **描述**: 尝试在不存在的 sandbox 中执行命令
- **预期**: 返回 404 错误

#### 5.2 读取不存在的文件
- **描述**: 在容器内执行 `cat /workspace/nonexistent.txt`
- **预期**: exit_code!=0, stderr 包含 "No such file"

#### 5.3 无权限操作
- **描述**: 尝试写入只读目录
- **预期**: 返回权限错误

#### 5.4 Agent 断连恢复
- **描述**: 模拟 agent 断连后重连
- **预期**: 重连后能继续执行命令

---

### 6. 性能测试

#### 6.1 快速创建删除 Sandbox
- **描述**: 连续创建并删除 5 个 sandbox
- **预期**: 所有操作在合理时间内完成

#### 6.2 批量文件操作
- **描述**: 通过 NFS 创建 100 个小文件
- **预期**: 所有文件创建成功

#### 6.3 大量命令执行
- **描述**: 在同一 sandbox 中执行 50 个命令
- **预期**: 所有命令正确执行

---

## 测试脚本

测试脚本位于: `tests/e2e/run_scenarios.sh`
